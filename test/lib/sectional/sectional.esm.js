class Entity{constructor(t,e,i){if(!(t&&e&&t in e))throw new Error(`Invalid parameters: ${t}, ${e}`);this._id=t,this._data=e,this._callback="function"==typeof i?i:t=>{}}idfmt(t){return`stnl-${t}`}clsfmt(t){return`stnl-${t}`}cssvarfmt(t){return`stnl${t}`}attrfmt(t){return`stnl-${t}`}_getData(){return this._data}_getEntity(t){return t&&t in this._data?this._data[t]:null}static Template(t){return t in Entity.TEMPLATE?Entity.TEMPLATE[t]:null}}Entity.TEMPLATE={entry:{children:[],title:"",type:"entry"},article:{children:[],title:"",type:"article"},section:{children:[],title:"",type:"section"},paragraph:{content:"",title:"",type:"paragraph"},code:{content:"",language:"",type:"code"},table:{classlist:"",content:{header:"",body:"",footer:""},properties:"",title:"",type:"table"},tableHeader:{children:[],type:"tableHeader"},tableColumn:{content:"",type:"tableColumn"},tableBody:{children:[],type:"tableBody"},tableRowHeader:{children:[],content:"",type:"tableRowHeader"},tableRow:{children:[],type:"tableRow"},tableCell:{content:"",type:"tableCell"},ledger:{classlist:"",content:{header:"",body:"",footer:""},properties:"",title:"",type:"ledger"},ledgerHeader:{content:{},type:"ledgerHeader"},ledgerBody:{children:[],type:"ledgerBody"},ledgerRecord:{content:{},type:"ledgerRecord"},ledgerFooter:{children:[],type:"ledgerFooter"}};const Debounce=(e,i,r=!1)=>{let n;return function(...t){!n&&r&&e.apply(this,t),clearTimeout(n),n=setTimeout(()=>e.apply(this,t),i)}};class ContentEntity extends Entity{constructor(t,e,i){super(t,e,i)}_setAction(t,e){if(!t)return null;t=this._getEntity(t);t&&(e.classList.add(this.clsfmt("action")),e.addEventListener("click",t=>{let e=t.target;e&&e.hasAttribute("action")&&((t=e.getAttribute("action"))&&this._action(t))}),e.setAttribute("action",t.action),(t=this._getEntity(t.action))&&"url"===t.type&&e.setAttribute("title",t.content))}_action(n){let s=this._getEntity(n);if(s)if("url"===s.type)window.open(s.content);else if("dataurl"===s.type){let t=s.content.split(",");n=t[0].match(/:(.*?);/)[1];let e=atob(t[1]),i=e.length,r=new Uint8Array(i);for(;i--;)r[i]=e.charCodeAt(i);window.open(URL.createObjectURL(new Blob([r],{type:n})))}}}class Paragraph extends ContentEntity{render(e){if(!e)throw new Error(`Invalid "parentEl": ${e}`);var i=this._getEntity(this._id);if(i){let t=document.createElement("p");return t.id=this.idfmt(this._id),t.innerHTML=i.content,e.appendChild(t),this._callback.call(this,t),t}}}class Image extends ContentEntity{render(e){if(!e)throw new Error(`Invalid "parentEl": ${e}`);var i=this._getEntity(this._id);if(i){let t=document.createElement("img");return t.id=this.idfmt(this._id),t.src=i.content,e.appendChild(t),t}}}class Code extends ContentEntity{render(i){if(!i)throw new Error(`Invalid "parentEl": ${i}`);var r=this._getEntity(this._id);if(r){let t=document.createElement("pre");t.id=this.idfmt(this._id),i.appendChild(t);let e=document.createElement("code");return e.className=`language-${r.language}`,e.innerHTML=r.content,t.appendChild(e),this._callback.call(this,t),t}}}class Ulist extends ContentEntity{render(t){if(!t)throw new Error(`Invalid "parentEl": ${t}`);t=this._getEntity(this._id);if(t)return document.createElement("ul")}}class Olist extends ContentEntity{render(t){if(!t)throw new Error(`Invalid "parentEl": ${t}`);t=this._getEntity(this._id);if(t)return document.createElement("ol")}}class Table extends ContentEntity{constructor(t,e,i){super(t,e,i),this._headerDepth=0,this._rowHeaderDepth=0,this._classlist=[];let r=this._getEntity(this._id);if(!r)throw new Error(`Invalid identifier of table: ${this._id}`);if(!("content"in r))throw new Error(`Incomplete entity: ${r.toString()}`);{let t=r.content;if(!("body"in t&&this._getEntity(t.body)))throw new Error(`Body is necessarily required: ${t.toString()}`)}var n;"properties"in r&&((n=this._getEntity(r.properties))&&n.content),"classlist"in r&&((n=this._getEntity(r.classlist))&&(this._classlist=n.content))}render(e){if(!e)throw new Error(`Invalid "parentEl": ${e}`);var i=this._getEntity(this._id);if(i){let t=document.createElement("table");return t.id=this.idfmt(this._id),t.classList.add("stnl-table"),e.appendChild(t),i.content.header&&this._header(i.content.header,t),i.content.body&&this._body(i.content.body,t),i.content.footer&&this._footer(i.content.footer,t),t}}_header(t,e){if(!e)throw new Error(`Invalid "parentEl": ${e}`);let i=this._getEntity(t);if(!i)throw new Error(`Invalid identifier of tableHeader: ${t}`);let r=document.createElement("thead");r.id=this.idfmt(t),e.appendChild(r);const n=t=>{let i=this._getEntity(t);if(!i)return 0;if(i.children){let e=0;return i.children.forEach(t=>{t=n(t)+1;e<t&&(r.appendChild(document.createElement("tr")),e=t)}),e}return r.appendChild(document.createElement("tr")),0};this._headerDepth=n(t),"children"in i&&i.children.length&&i.children.forEach((t,e)=>{var i=this._getEntity(t);i&&"tableColumn"===i.type&&this._column(t,r,0,e)})}_column(t,n,s,l){if(!n)throw new Error(`Invalid "parentEl": ${n}`);let e=this._getEntity(t);if(!e)throw new Error(`Invalid identifier of tableColumn: ${t}`);let i=document.createElement("th");var r;if(i.id=this.idfmt(t),i.innerHTML=e.content,n.children[s].appendChild(i),"action"in e&&e.action&&this._setAction(t,i),i.previousElementSibling&&(!i.previousElementSibling.hasAttribute("col")||(r=i.previousElementSibling.getAttribute("col"))&&(l=parseInt(r,10)),i.previousElementSibling.hasAttribute("colspan")?(r=i.previousElementSibling.getAttribute("colspan"))&&(l+=parseInt(r,10)):l+=1),i.setAttribute("col",l.toString()),i.setAttribute("row",s.toString()),this._classlist&&l<this._classlist.length&&i.classList.add.apply(i.classList,this._classlist[l]),this._callback.call(this,i),"children"in e&&e.children.length){let r=0;return e.children.forEach((t,e)=>{var i=this._getEntity(t);i&&"tableColumn"===i.type&&(e=this._column(t,n,s+1,l+e)+1,r<e&&(r=e))}),1<r&&i.setAttribute("colspan",r.toString()),r}return s<this._headerDepth-1&&i.setAttribute("rowspan",(this._headerDepth-s).toString()),1}_body(t,e){if(!e)throw new Error(`Invalid "parentEl": ${e}`);let i=this._getEntity(t);if(!i)throw new Error(`Invalid identifier of tableBody: ${t}`);let r=document.createElement("tbody");r.id=this.idfmt(t),e.appendChild(r);const n=t=>{let e=this._getEntity(t);if(!e)return 0;if("children"in e&&e.children.length){let i=0;return e.children.forEach(t=>{var e=this._getEntity(t);e&&"tableRowHeader"===e.type&&(t=n(t)+1,i<t&&(i=t))}),i}return 0};this._rowHeaderDepth=n(t),"children"in i&&i.children.length&&i.children.forEach((t,e)=>{var i=this._getEntity(t);i&&("tableRowHeader"===i.type?this._rowHeader(t,r,e,0,!1):"tableRow"===i.type&&this._row(t,r,e,0,!1))})}_rowHeader(t,l,o,a,e){if(!l)throw new Error(`Invalid "parentEl": ${l}`);let i=this._getEntity(t);if(!i)throw new Error(`Invalid identifier of tableRowHeader: ${t}`);e||(e=document.createElement("tr"),l.appendChild(e),o=l.children.length-1);let h=document.createElement("td");if(h.id=this.idfmt(t),h.innerHTML=i.content,h.classList.add(this.clsfmt("row-header")),l.children[o].appendChild(h),"action"in i&&i.action&&this._setAction(t,h),"help"in i&&i.help&&h.setAttribute("title",i.help),h.setAttribute("row",o.toString()),h.setAttribute("col",a.toString()),this._classlist&&a<this._classlist.length&&h.classList.add.apply(h.classList,this._classlist[a]),this._callback.call(this,h),"children"in i&&i.children.length){let s=0;return i.children.forEach((i,r)=>{var n=this._getEntity(i);if(n){let t=0;"tableRowHeader"!==n.type&&(t=this._rowHeaderDepth-a,h.setAttribute("colspan",t.toString()));let e=0;if("tableRowHeader"===n.type)e=this._rowHeader(i,l,o,a+(t||1),0===r);else{if("tableRow"!==n.type)throw new Error(`Invalid child entity: ${n.type}`);e=this._row(i,l,o,a+(t||1),0===r)}o+=e,s+=e}}),1<s&&h.setAttribute("rowspan",s.toString()),s}return 1}_row(e,r,n,s,t){if(!r)throw new Error(`Invalid "parentEl": ${r}`);let i=this._getEntity(e);if(!i)throw new Error(`Invalid identifier of tableRow: ${e}`);if(!t){let t=document.createElement("tr");t.id=this.idfmt(e),r.appendChild(t)}return"children"in i&&i.children.length&&i.children.forEach((t,e)=>{var i=this._getEntity(t);i&&"tableCell"===i.type&&this._cell(t,r,n,s+e)}),1}_cell(e,t,i,r){if(!t)throw new Error(`Invalid "parentEl": ${t}`);let n=this._getEntity(e);if(!n)throw new Error(`Invalid identifier of tableCell: ${e}`);let s=document.createElement("td");if(s.id=this.idfmt(e),t.children[i].appendChild(s),"action"in n&&n.action&&this._setAction(e,s),"help"in n&&n.help&&s.setAttribute("title",n.help),"highlight"in n&&n.highlight){e=n.content.replace(/\s*\([^)]*\)\s*/g,"");s.innerHTML=n.content.substring(e.length);let t=document.createElement("strong");t.innerHTML=e,s.prepend(t)}else s.innerHTML=n.content;s.setAttribute("row",i.toString()),s.setAttribute("col",r.toString()),this._classlist&&r<this._classlist.length&&s.classList.add.apply(s.classList,this._classlist[r]),this._callback.call(this,s)}_footer(t,e){}}class Ledger extends ContentEntity{constructor(t,e,i){super(t,e,i),this._keys=[],this._types={},this._records=[],this._values={},this._mask=[],this._filter={},this._sort={},this._classlist={};let r=this._getEntity(this._id);if(!r)throw new Error(`Invalid identifier of ledger: ${this._id}`);if(!("content"in r))throw new Error(`Incomplete entity: ${r.toString()}`);{let t=r.content;if(!("header"in t))throw new Error(`Header is necessarily required: ${t.toString()}`);if(!("body"in t))throw new Error(`Body is necessarily required: ${t.toString()}`);let e=this._getEntity(t.header);if(!e)throw new Error(`Invalid identifier of ledger header: ${t.header}`);if(!("content"in e))throw new Error(`Incomplete header entity: ${e}`);Object.keys(e.content).forEach(t=>{e&&(this._keys.push(t),this._types[t]=e.content[t])});let i=this._getEntity(t.body);if(!i)throw new Error(`Invalid identifier of ledger body: ${t.body}`);if(!("children"in i))throw new Error(`Incomplete body entity: ${i}`);i.children.forEach(t=>{this._records.push(t)})}if("properties"in r){var n=this._getEntity(r.properties);if(n){let e=n.content;if("display"in e&&(this._keys=[],e.display.forEach(t=>{this._keys.push(t)})),"filter"in e&&(this._filter=e.filter),"sort"in e){this._sort=e.sort;let t=[];for(const s of this._keys)s in this._sort&&t.push({key:s,order:this._sort[s]});this.sort(t)}}}this._keys.forEach(t=>{this._classlist[t]=[]}),"classlist"in r&&((n=this._getEntity(r.classlist))&&(this._classlist=n.content));for(let e=0;e<this._records.length;e++){this._mask.push(new Array(this._keys.length));for(let t=0;t<this._keys.length;t++)this._mask[e][t]=1}for(const l of this._keys)this._values[l]=[]}sort(a){a&&a.length&&this._records.sort((e,i)=>{let r=0;for(let t=0;t<a.length&&0==r;t++){var n,s,l,o=a[t].key;o&&(n=a[t].order?"ascending"===a[t].order?1:-1:0,l=this._getEntity(e),s=this._getEntity(i),l&&s&&(l=l.content[o],o=s.content[o],r=l===o?0:(o<l?1:-1)*n))}return r})}render(e){if(!e)throw new Error(`Invalid "parentEl": ${e}`);var i=this._getEntity(this._id);if(i){let t=document.createElement("table");return t.id=this.idfmt(this._id),t.classList.add(this.clsfmt("ledger")),e.appendChild(t),i.content.footer&&this._footer(i.content.footer,t),i.content.body&&this._body(i.content.body,t),i.content.header&&this._header(i.content.header,t),t}}_header(t,e){if(!e)throw new Error(`Invalid "parentEl": ${e}`);if(!this._getEntity(t))throw new Error(`Invalid identifier of ledgerHeader: ${t}`);let i=document.createElement("thead");i.id=this.idfmt(t),e.appendChild(i);let s=document.createElement("tr");i.appendChild(s);t=document.createElement("th");if(s.appendChild(t),this._keys.forEach((t,e)=>{let i=document.createElement("th");i.setAttribute("row","0"),i.setAttribute("col",e.toString()),s.appendChild(i);let r=document.createElement("input");r.type="text",r.id=this.idfmt(`combobox-${this._id}-${t}`),r.className=this.clsfmt("filter-combobox"),r.title=t,r.placeholder=t,r.setAttribute("list",this.idfmt(`datalist-${this._id}-${t}`)),r.setAttribute("col",e.toString()),r.addEventListener("keydown",t=>{t.stopPropagation();let e=t.target;e&&"Escape"===t.key&&(e.value="",e.dispatchEvent(new Event("input")))}),r.addEventListener("keypress",t=>{t.stopPropagation()}),r.addEventListener("input",Debounce(i=>{i.stopPropagation();let l=i.target;var n=this._getEntity(this._id);if(n){let e=document.querySelector(`#${this.idfmt(this._id)}`),t=e.querySelector("tbody");var o=t.querySelectorAll("tr");let s=parseInt(l.getAttribute("col"))+1;if(Array.from(o).forEach((t,e)=>{this._mask[e][s]=1}),l.value.length?(l.setAttribute("list",""),Array.from(o).forEach((e,i)=>{try{var r=new RegExp(`${l.value}`,"gi");let t=e.childNodes[s].innerText;var n=t.match(r);n&&n.length||(this._mask[i][s]=0)}catch(t){}})):(i=new RegExp(`^${this.idfmt("combobox")}`,"gi"),l.setAttribute("list",l.id.replace(i,this.idfmt("datalist")))),n.content.footer){let t=e.querySelector("tfoot > tr");for(;t&&t.lastChild;)t.removeChild(t.lastChild);this._footer(n.content.footer,e)}Object.keys(this._values).forEach(t=>{this._values[t]=[]});let r=1;Array.from(o).forEach((t,e)=>{if(this._mask[e].reduce((t,e)=>t*e)){t.classList.remove("hidden");let i=this._records[e];this._keys.forEach(t=>{var e=this._getEntity(i);!e||(e=e.content[t])&&this._values[t].indexOf(e)<0&&this._values[t].push(e)}),t.firstElementChild&&(t.firstElementChild.innerHTML=r.toString(),r++)}else t.classList.add("hidden")}),Object.keys(this._values).forEach(r=>{r in this._sort&&this._values[r].sort((t,e)=>{var i=this._sort[r]?"ascending"===this._sort[r]?1:-1:0;return t==e?0:(e<t?1:-1)*i})}),this._keys.forEach((t,e)=>{var i=this.idfmt(`datalist-${this._id}-${t}`);let r=document.querySelector(`#${i}`);for(;r&&r.lastChild;)r.removeChild(r.lastChild);this._values[t].forEach(t=>{let e=document.createElement("option");e.value=t,e.innerHTML=t,r.appendChild(e)})})}},500)),i.appendChild(r);let n=document.createElement("datalist");n.id=this.idfmt(`datalist-${this._id}-${t}`),i.appendChild(n),this._values[t].forEach(t=>{let e=document.createElement("option");e.value=t,e.innerHTML=t,n.appendChild(e)})}),this._filter){let r=e.querySelectorAll(`.${this.clsfmt("filter-combobox")}`);r.length&&this._keys.forEach((e,i)=>{e=this._filter[e];if(e){let t=r[i];t.value=e,t.dispatchEvent(new Event("input"))}})}}_body(t,e){if(!e)throw new Error(`Invalid "parentEl": ${e}`);if(!this._getEntity(t))throw new Error(`Invalid identifier of ledgerBody: ${t}`);let r=document.createElement("tbody");r.id=this.idfmt(t),r.style.setProperty(`--${this.cssvarfmt("RowCounterId")}`,e.id),e.appendChild(r),this._records.forEach((t,e)=>{var i=this._getEntity(t);i&&"ledgerRecord"===i.type&&this._putRecord(e+1,t,r)}),Object.keys(this._values).forEach(r=>{r in this._sort&&this._values[r].sort((t,e)=>{var i=this._sort[r]?"ascending"===this._sort[r]?1:-1:0;return t==e?0:(e<t?1:-1)*i})})}_putRecord(e,r,n){if(!n)throw new Error(`Invalid "parentEl": ${n}`);var s=this._getEntity(r);if(s){let i=document.createElement("tr");i.id=this.idfmt(r),i.style.setProperty(`--${this.cssvarfmt("RowCounterId")}`,n.id),n.appendChild(i);let t=document.createElement("td");t.innerHTML=e.toString(),i.appendChild(t);for(const l of this._keys){let t=document.createElement("td");i.appendChild(t);let e=s.content[l];"number"===this._types[l]||"price"===this._types[l]?e?"price"===this._types[l]?t.innerHTML=e.toLocaleString():t.innerHTML=e:t.innerHTML="0":e?t.innerHTML=e:t.innerHTML="",this._classlist&&this._classlist[l].length&&t.classList.add.apply(t.classList,this._classlist[l]),e&&this._values[l].indexOf(e)<0&&this._values[l].push(e)}}else console.log(`Invalid identifier of ledgerRecord: ${r}`)}_footer(t,e){if(!e)throw new Error(`Invalid "parentEl": ${e}`);var i=this._getEntity(t);if(!i)throw new Error(`Invalid identifier of ledgerFooter: ${t}`);let r=e.querySelector("tfoot");r||(r=document.createElement("tfoot"),r.id=this.idfmt(t),e.appendChild(r));let n=r.querySelector("tr");n||(n=document.createElement("tr"),r.appendChild(n));e=document.createElement("td");n.appendChild(e);for(const l of this._keys){var s=i.content[l]||"";let t=document.createElement("td");if(t.setAttribute(this.attrfmt("footer-label"),s),n.appendChild(t),"total"===s){let i=0;this._records.forEach((t,e)=>{t=this._getEntity(t);t&&this._mask[e].reduce((t,e)=>t*e)&&(i+=t.content[l])}),t.innerHTML=i.toLocaleString()}else if("variety"===s){let r=[];this._records.forEach((t,e)=>{let i=this._getEntity(t);i&&this._mask[e].reduce((t,e)=>t*e)&&r.push(i.content[l].toString())}),t.innerHTML=[...new Set(Array.from(r))].length.toLocaleString()}else if("count"===s){let i=0;this._records.forEach((t,e)=>{this._mask[e].reduce((t,e)=>t*e)&&(i+=1)}),t.innerHTML=i.toLocaleString()}}}}var ContentEntities=Object.freeze({__proto__:null,ContentEntity:ContentEntity,Paragraph:Paragraph,Image:Image,Code:Code,Ulist:Ulist,Olist:Olist,Table:Table,Ledger:Ledger});class LayoutEntity extends Entity{constructor(t,e,i){super(t,e,i)}_children(n,t,s){t&&t.forEach(i=>{let t=this._getEntity(i);if(t){let e=t.type.toLowerCase();if("section"===e)this.section(i,n,s);else{var r=e.replace(/^.{1}/g,t=>t.toUpperCase());let t=this._createContentEntity(r,i);t.render(n)}}})}_createContentEntity(t,e){const i=ContentEntities;if(i[t]&&void 0!==i[t])return new i[t](e,this._getData(),this._callback);throw new Error("Class not found: "+t)}article(i,t,e=!0){if(!i||!t)throw new Error("Invalid parameters: article(id: string, parentEl: HTMLElement)");let r=this._getEntity(i);if(r){if("article"!==r.type)throw new Error(`Invalid entity type: ${r.type}`);if(e){let e=document.createElement("article");if(e.id=this.idfmt(i),t.appendChild(e),r._dom=e,r.title){let t=document.createElement("h1");t.id=this.idfmt(i),t.innerHTML=r.title,e.appendChild(t)}}this._children(e?r._dom:t,r.children,e)}}section(i,r,t=!0){if(!i||!r)throw new Error("Invalid parameters: section(id: string, parentEl: HTMLElement)");let n=this._getEntity(i);if(n){if("section"!==n.type)throw new Error(`Invalid entity type: ${n.type}`);if(t){let e=document.createElement("section");if(r.appendChild(e),n._dom=e,n.title){let t=document.createElement("h"+n._depth);t.id=this.idfmt(i),t.innerHTML=n.title,e.appendChild(t),e.setAttribute("area-label",n.title),this._callback.call(this,t)}}else if(n.title){let t=document.createElement("h"+n._depth);t.id=this.idfmt(i),t.innerHTML=n.title,r.appendChild(t),this._callback.call(this,t)}this._children(t?n._dom:r,n.children,t)}}}class Sectional{constructor(t,e,i){if(this._callback=t=>{},this._insertSections=!0,this._entry="0000000000000000000000",!t||!e)throw new Error("Missing parameters!");this._viewport=t,this._data=e,i&&("callback"in i&&"function"==typeof i.callback&&(this._callback=i.callback),"insertSections"in i&&"boolean"==typeof i.insertSections&&(this._insertSections=i.insertSections),"entry"in i&&"string"==typeof i.entry&&(this._entry=i.entry));const n=(e,i,r)=>{if(e){let t=this._data[e];t&&(t._id=e,t._depth=r,i&&("_parents"in t||(t._parents=[]),t._parents.includes(i)||t._parents.push(i)),"children"in t&&t.children.forEach(t=>{n(t,e,r+1)}),"content"in t&&"object"==typeof t.content&&("header"in t.content&&n(t.content.header,e,r+1),"body"in t.content&&n(t.content.body,e,r+1),"footer"in t.content&&n(t.content.footer,e,r+1)),"classlist"in t&&n(t.classlist,e,r+1),"properties"in t&&n(t.properties,e,r+1),"action"in t&&n(t.action,e,r+1))}};n(this._entry,"",0)}getEntry(){return this._entry}getData(){return this._data}setData(t){this._data=t}exportData(t=!0){let r=JSON.parse(JSON.stringify(this._data));return t&&Object.keys(r).forEach(t=>{let e=r[t];for(const i of Object.keys(e))i.startsWith("_")&&delete e[i]}),r}getEntity(t){return t in this._data?this._data[t]:null}setEntity(t,e){try{return this._data[t]=e,!0}catch(t){return!1}}setMetadata(){}removeEntity(t){if(t&&t in this._data){var e=this._data[t];return e&&"children"in e&&e.children,delete this._data[t],!0}return!1}cleanup(){}getArticles(){var t=this._data[this._entry];return t?t.children:[]}article(t){this.clearViewport();let e=new LayoutEntity(t,this._data,this._callback);e.article(t,this._viewport,this._insertSections)}clearViewport(){for(;this._viewport.lastChild;)this._viewport.removeChild(this._viewport.lastChild)}}export{Sectional};
